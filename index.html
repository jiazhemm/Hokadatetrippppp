<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>å‡½é¤¨å†¬ä¹‹æ—… - æ™‚é–“è»¸ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #E0F2FE; margin: 0; padding: 0; }
        [v-cloak] { display: none; }
        .brutal-card { background: white; border: 3px solid #000; box-shadow: 4px 4px 0px #000; transition: all 0.1s; }
        .brutal-btn:active { box-shadow: 0px 0px 0px #000; transform: translate(2px, 2px); }
        .pink-accent { background-color: #FFB7C5; }
        .tab-active { background-color: #FFB7C5 !important; transform: translateY(-3px); }
        .curved-header { border-bottom-left-radius: 40px; border-bottom-right-radius: 40px; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        input, select, textarea { border: 2px solid #000 !important; border-radius: 10px !important; padding: 6px 10px; font-weight: bold; width: 100%; font-size: 14px; }
        .safe-pb { padding-bottom: calc(120px + env(safe-area-inset-bottom)); }
        
        /* æ™‚é–“è»¸è£é£¾ç·š */
        .timeline-line { position: absolute; left: 2.25rem; top: 0; bottom: 0; width: 3px; background: #000; z-index: 0; }
    </style>
</head>
<body class="overflow-x-hidden">

<div id="app" v-cloak>
    <header class="relative bg-blue-400 h-36 curved-header border-b-4 border-black">
        <div class="p-6">
            <h1 class="text-xl font-black text-white drop-shadow-[2px_2px_0_rgba(0,0,0,1)] uppercase">HAKODATE TIMELINE</h1>
        </div>
        <div class="absolute -bottom-4 left-0 right-0 flex justify-center gap-2 px-4 z-20">
            <button v-for="tab in tabs" :key="tab.id" @click="currentTab = tab.id"
                :class="['brutal-card p-3 rounded-2xl flex flex-col items-center flex-1', currentTab === tab.id ? 'tab-active' : 'bg-white']">
                <i :data-lucide="tab.icon" class="w-5 h-5"></i>
            </button>
        </div>
    </header>

    <main class="mt-8 px-4 safe-pb">
        <section v-if="currentTab === 'schedule'" class="relative space-y-8">
            <div class="flex overflow-x-auto gap-3 py-2 no-scrollbar relative z-10">
                <div v-for="d in dates" :key="d.fullDate" @click="activeDate = d.fullDate"
                    :class="['flex-shrink-0 brutal-card w-14 h-20 rounded-xl flex flex-col items-center justify-center cursor-pointer', activeDate === d.fullDate ? 'pink-accent' : 'bg-white']">
                    <span class="text-[10px] font-black uppercase">{{ d.day }}</span>
                    <span class="text-xl font-black">{{ d.date }}</span>
                </div>
            </div>

            <div class="relative min-h-[400px]">
                <div class="timeline-line opacity-20"></div>

                <div v-if="activeDate === '2025-12-28'" class="flex gap-4 items-start mb-8 relative z-10">
                    <div class="w-16 flex-shrink-0 text-center">
                        <p class="text-lg font-black leading-none">06:45</p>
                        <p class="text-[10px] font-bold opacity-40">START</p>
                    </div>
                    <div class="brutal-card flex-1 p-4 rounded-2xl bg-[#FFD700]">
                        <div class="flex justify-between items-center mb-1">
                            <span class="font-black text-xs">ğŸ¯ Tigerair IT0236</span>
                            <i data-lucide="plane" class="w-4 h-4"></i>
                        </div>
                        <h3 class="text-lg font-black">æ¡ƒåœ’ TPE âœ å‡½é¤¨ HKD</h3>
                        <p class="text-[10px] font-bold mt-1">é è¨ˆæŠµé”æ™‚é–“ 11:10</p>
                    </div>
                </div>

                <div v-for="item in filteredSchedule" :key="item.cid" class="flex gap-4 items-start mb-8 relative z-10">
                    <div class="w-16 flex-shrink-0 text-center">
                        <p class="text-lg font-black leading-none">{{ item.time }}</p>
                        <div class="w-2 h-2 bg-black rounded-full mx-auto mt-2 border-2 border-white shadow-sm"></div>
                    </div>
                    <div class="brutal-card flex-1 p-4 rounded-2xl bg-white" @click="editItem(item)">
                        <div class="flex justify-between items-start mb-1">
                            <span class="text-[9px] bg-black text-white px-2 py-0.5 rounded font-black">{{ item.category }}</span>
                            <button @click.stop="openMaps(item.title)" class="p-1.5 bg-blue-50 border-2 border-black rounded-lg brutal-btn">
                                <i data-lucide="navigation" class="w-3 h-3"></i>
                            </button>
                        </div>
                        <h3 class="text-md font-black">{{ item.title }}</h3>
                        <p v-if="item.note" class="text-xs mt-2 text-gray-500 italic font-medium leading-tight">"{{ item.note }}"</p>
                    </div>
                </div>

                <div v-if="activeDate === '2026-01-01'" class="flex gap-4 items-start mb-8 relative z-10">
                    <div class="w-16 flex-shrink-0 text-center">
                        <p class="text-lg font-black leading-none">12:20</p>
                        <p class="text-[10px] font-bold opacity-40">END</p>
                    </div>
                    <div class="brutal-card flex-1 p-4 rounded-2xl bg-[#FFD700]">
                        <div class="flex justify-between items-center mb-1">
                            <span class="font-black text-xs">ğŸ¯ Tigerair IT0237</span>
                            <i data-lucide="plane" class="w-4 h-4 rotate-180"></i>
                        </div>
                        <h3 class="text-lg font-black">å‡½é¤¨ HKD âœ æ¡ƒåœ’ TPE</h3>
                        <p class="text-[10px] font-bold mt-1">é è¨ˆæŠµé”æ™‚é–“ 16:00</p>
                    </div>
                </div>
                
                <div v-if="filteredSchedule.length === 0 && activeDate !== '2025-12-28' && activeDate !== '2026-01-01'" class="text-center py-20 opacity-20 font-black italic">
                    é‚„æ²’æœ‰å®‰æ’è¡Œç¨‹å–”...
                </div>
            </div>
        </section>

        <section v-if="currentTab === 'shop'" class="space-y-4">
            <div class="brutal-card p-4 rounded-2xl bg-white">
                <h3 class="font-black mb-2 text-sm">å…ç¨…è¨ˆç®—æ©Ÿ</h3>
                <div class="flex gap-2 mb-3">
                    <input type="number" v-model.number="taxCalc.input" placeholder="é‡‘é¡" class="flex-1">
                    <select v-model="taxCalc.type" class="w-24">
                        <option value="C">æ¶ˆè€—å“</option>
                        <option value="G">ä¸€èˆ¬å“</option>
                    </select>
                </div>
                <button @click="addTax" class="brutal-card w-full py-2 pink-accent font-black brutal-btn mb-2">åŠ å…¥è¨ˆç®—</button>
                <div class="text-[11px] font-black text-gray-600">
                    <span>æ¶ˆè€—å“: Â¥{{taxCalc.sumC}} | ä¸€èˆ¬å“: Â¥{{taxCalc.sumG}}</span>
                    <p class="text-blue-600 mt-1">é è¨ˆé€€ç¨…å¾Œ: Â¥{{calcTaxResult}} <span @click="resetTax" class="ml-2 underline cursor-pointer opacity-50">é‡ç½®</span></p>
                </div>
            </div>
            <div class="brutal-card p-3 rounded-2xl bg-blue-50">
                <div class="grid grid-cols-2 gap-2 text-[10px] font-black">
                    <div v-for="n in [1,3,5,10]" class="flex justify-between border-b border-blue-200">
                        <span>{{n*1000}}å††</span><span>${{n*210}}</span>
                    </div>
                </div>
            </div>
        </section>

        <section v-if="currentTab === 'cost'" class="space-y-4">
            <div class="brutal-card p-4 rounded-[30px] bg-white border-4">
                <h3 class="font-black text-center text-xs mb-3">çµç®—å ±è¡¨ (TWD)</h3>
                <div class="grid grid-cols-2 gap-3 mb-3">
                    <div class="bg-pink-50 p-2 rounded-xl border-2 border-black text-center">
                        <p class="text-[8px] font-black">ğŸ’— æ”¯ä»˜</p><p class="text-sm font-black">${{ Math.round(splitReport.pinkPaid) }}</p>
                    </div>
                    <div class="bg-blue-50 p-2 rounded-xl border-2 border-black text-center">
                        <p class="text-[8px] font-black">ğŸ’™ æ”¯ä»˜</p><p class="text-sm font-black">${{ Math.round(splitReport.bluePaid) }}</p>
                    </div>
                </div>
                <div class="pink-accent p-2 rounded-xl border-2 border-black text-center font-black">
                    <p class="text-[10px] italic leading-none">{{ splitReport.message }}</p>
                    <p class="text-xl">${{ Math.round(splitReport.diff) }}</p>
                </div>
            </div>
            <div class="space-y-2">
                <div v-for="c in costs" :key="c.cid" @click="editItem(c)" class="brutal-card p-3 rounded-xl flex justify-between items-center bg-white">
                    <div class="flex items-center gap-2">
                        <span class="text-lg">{{ c.payer === 'pink' ? 'ğŸ’—' : 'ğŸ’™' }}</span>
                        <p class="font-black text-xs">{{ c.title }}</p>
                    </div>
                    <span class="font-black text-xs italic">{{ c.currency === 'JPY' ? 'Â¥' : '$' }}{{ c.amount }}</span>
                </div>
            </div>
        </section>
    </main>

    <div class="fixed bottom-6 left-0 right-0 px-8 z-40">
        <button @click="prepareNew" class="brutal-card pink-accent py-4 rounded-full font-black text-lg w-full brutal-btn shadow-[6px_6px_0px_#000]">
            + ADD RECORD
        </button>
    </div>

    <transition name="modal">
        <div v-if="showModal" class="fixed inset-0 z-[100] flex flex-col justify-end">
            <div class="absolute inset-0 bg-black/60" @click="showModal = false"></div>
            <div class="brutal-card bg-white w-full rounded-t-[40px] p-6 pb-12 z-10 max-h-[85vh] overflow-y-auto">
                <div class="space-y-4">
                    <div class="flex gap-2">
                        <select v-model="form.category" class="flex-1"><option v-for="cat in activeCats" :value="cat">{{cat}}</option></select>
                        <select v-model="form.currency" class="w-24"><option value="JPY">JPY Â¥</option><option value="TWD">TWD $</option></select>
                    </div>
                    <input v-model="form.title" placeholder="é …ç›®åç¨±">
                    <div class="grid grid-cols-2 gap-3">
                        <input v-model.number="form.amount" type="number" placeholder="é‡‘é¡">
                        <input v-model="form.time" type="time">
                    </div>
                    <div v-if="currentTab === 'cost'" class="brutal-card p-3 rounded-xl bg-gray-50 flex items-center justify-between">
                        <span class="font-black text-xs">æ”¯ä»˜äºº:</span>
                        <div class="flex gap-4">
                            <label class="flex items-center gap-1 font-black cursor-pointer"><input type="radio" v-model="form.payer" value="pink"> ğŸ’—</label>
                            <label class="flex items-center gap-1 font-black cursor-pointer"><input type="radio" v-model="form.payer" value="blue"> ğŸ’™</label>
                        </div>
                        <div class="flex items-center gap-1 font-black"><span class="text-[10px]">å¹³æ”¤?</span><input type="checkbox" v-model="form.isSplit"></div>
                    </div>
                    <textarea v-model="form.note" placeholder="å‚™è¨»" rows="2"></textarea>
                    <div class="flex gap-3">
                        <button v-if="isEditing" @click="delItem" class="brutal-card bg-red-400 p-3 rounded-xl flex-1 font-black">åˆªé™¤</button>
                        <button @click="saveToCloud" class="brutal-card pink-accent p-3 rounded-xl flex-[2] font-black">å­˜æª”åŒæ­¥</button>
                    </div>
                </div>
            </div>
        </div>
    </transition>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyCAxd41_3A4bnrI0M0n4Br0GK62zkKqIqY",
  authDomain: "hakodate-trip-app.firebaseapp.com",
  databaseURL: "https://hakodate-trip-app-default-rtdb.firebaseio.com",
  projectId: "hakodate-trip-app",
  storageBucket: "hakodate-trip-app.firebasestorage.app",
  messagingSenderId: "632761576586",
  appId: "1:632761576586:web:19d77a52326cb62cd1d173"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const { createApp, ref, computed, onMounted, watch, nextTick } = Vue;

createApp({
    setup() {
        const currentTab = ref('schedule');
        const activeDate = ref('2025-12-28');
        const showModal = ref(false);
        const isEditing = ref(false);
        const form = ref({});
        const schedules = ref([]);
        const costs = ref([]);
        const taxCalc = ref({ input: null, type: 'C', sumC: 0, sumG: 0 });

        onMounted(() => {
            db.ref('schedules').on('value', s => { const v = s.val(); schedules.value = v ? Object.keys(v).map(k => ({...v[k], cid: k})) : []; });
            db.ref('costs').on('value', s => { const v = s.val(); costs.value = v ? Object.keys(v).map(k => ({...v[k], cid: k})) : []; });
            lucide.createIcons();
        });

        const activeCats = computed(() => ['ç¾é£Ÿ','æ™¯é»','è³¼ç‰©','äº¤é€š','æ©Ÿé…’','é–€ç¥¨','ä½å®¿','å…¶ä»–']);
        const filteredSchedule = computed(() => schedules.value.filter(s => s.date === activeDate.value).sort((a,b) => (a.time||'').localeCompare(b.time||'')));
        
        const splitReport = computed(() => {
            let pP = 0, bP = 0, pS = 0, bS = 0;
            costs.value.forEach(c => {
                const twd = c.currency === 'JPY' ? c.amount * 0.21 : c.amount;
                if (c.payer === 'pink') pP += twd; else bP += twd;
                if (c.isSplit) { pS += twd/2; bS += twd/2; } else { if (c.payer === 'pink') pS += twd; else bS += twd; }
            });
            const diff = pP - pS;
            return { pinkPaid: pP, bluePaid: bP, diff: Math.abs(diff), message: diff >= 0 ? "ğŸ’™ æ‡‰çµ¦ ğŸ’—" : "ğŸ’— æ‡‰çµ¦ ğŸ’™" };
        });

        const calcTaxResult = computed(() => {
            let r = 0;
            r += taxCalc.value.sumC >= 5000 ? taxCalc.value.sumC * 0.909 : taxCalc.value.sumC;
            r += taxCalc.value.sumG >= 5000 ? taxCalc.value.sumG * 0.909 : taxCalc.value.sumG;
            return Math.round(r);
        });

        const addTax = () => { if(taxCalc.value.input){ if(taxCalc.value.type==='C') taxCalc.value.sumC+=taxCalc.value.input; else taxCalc.value.sumG+=taxCalc.value.input; taxCalc.value.input=null; } };
        const resetTax = () => { taxCalc.value.sumC=0; taxCalc.value.sumG=0; };

        const prepareNew = () => { isEditing.value = false; form.value = { title:'', time:'12:00', amount:null, note:'', category:'ç¾é£Ÿ', currency:'JPY', payer:'pink', isSplit: true }; showModal.value = true; };
        const saveToCloud = () => {
            const path = currentTab.value === 'schedule' ? 'schedules' : 'costs';
            if(isEditing.value) db.ref(`${path}/${form.value.cid}`).update({...form.value, date: activeDate.value});
            else db.ref(path).push({...form.value, date: activeDate.value, id: Date.now()});
            showModal.value = false;
        };
        const editItem = (item) => { isEditing.value = true; form.value = { ...item }; showModal.value = true; };
        const delItem = () => { if(confirm('åˆªé™¤ï¼Ÿ')) { const path = currentTab.value === 'schedule' ? 'schedules' : 'costs'; db.ref(`${path}/${form.value.cid}`).remove(); showModal.value = false; } };
        const openMaps = (n) => window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(n)}`, '_blank');
        watch([currentTab, showModal], () => nextTick(() => lucide.createIcons()));

        return { currentTab, activeDate, showModal, isEditing, form, schedules, costs, filteredSchedule, splitReport, activeCats, taxCalc, calcTaxResult, addTax, resetTax, prepareNew, saveToCloud, editItem, delItem, openMaps, tabs: [{id:'schedule',icon:'map'}, {id:'shop',icon:'shopping-basket'}, {id:'cost',icon:'banknote'}], dates: [{day:'Sun',date:'28',fullDate:'2025-12-28'},{day:'Mon',date:'29',fullDate:'2025-12-29'},{day:'Tue',date:'30',fullDate:'2025-12-30'},{day:'Wed',date:'31',fullDate:'2025-12-31'},{day:'Thu',date:'01',fullDate:'2026-01-01'}] };
    }
}).mount('#app');
</script>
</body>
</html>
