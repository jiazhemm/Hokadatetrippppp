<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>HAKODATE 2025 - ç³»çµ±ä¿®å¾©è¯å‹•ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://SortableJS.github.io/Sortable/Sortable.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #E0F2FE; margin: 0; padding: 0; }
        [v-cloak] { display: none; }
        .brutal-card { background: white; border: 3px solid #000; box-shadow: 6px 6px 0px #000; transition: all 0.1s; }
        .brutal-btn:active { box-shadow: 0px 0px 0px #000; transform: translate(3px, 3px); }
        .pink-accent { background-color: #FFB7C5; }
        .curved-header { border-bottom-left-radius: 50px; border-bottom-right-radius: 50px; padding-top: env(safe-area-inset-top); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        input, select, textarea { border: 3px solid #000 !important; border-radius: 12px !important; padding: 10px; width: 100%; font-weight: bold; }
        .photo-box { width: 100%; aspect-ratio: 1 / 1; border: 3px solid #000; border-radius: 15px; object-fit: cover; }
        .timeline-line { position: absolute; left: 4.8rem; top: 0; bottom: 0; width: 3px; background: #000; opacity: 0.1; }
        .drag-handle { cursor: grab; }
        .flight-fixed { background: linear-gradient(135deg, #fff 0%, #fff 70%, #ffcc00 100%); border: 3px solid #000; }
    </style>
</head>
<body class="pb-32">

<div id="app" v-cloak>
    <header class="relative bg-blue-400 h-40 curved-header border-b-4 border-black text-center">
        <div class="p-8"><h1 class="text-3xl font-black text-white drop-shadow-[3px_3px_0_rgba(0,0,0,1)] italic uppercase">HAKODATE 2025</h1></div>
        <div class="absolute -bottom-6 left-0 right-0 flex justify-center gap-3 px-6 z-20">
            <button v-for="tab in tabs" :key="tab.id" @click="currentTab = tab.id"
                :class="['brutal-card p-4 rounded-2xl flex flex-col items-center flex-1 max-w-[100px]', currentTab === tab.id ? 'pink-accent -translate-y-2' : 'bg-white']">
                <i :data-lucide="tab.icon" class="w-6 h-6"></i>
            </button>
        </div>
    </header>

    <main class="mt-16 px-6 max-w-4xl mx-auto">
        <section v-if="currentTab === 'schedule'" class="space-y-6 relative">
            <div class="flex overflow-x-auto gap-4 py-2 no-scrollbar">
                <div v-for="d in dates" :key="d.fullDate" @click="activeDate = d.fullDate"
                    :class="['flex-shrink-0 brutal-card w-16 h-24 rounded-2xl flex flex-col items-center justify-center cursor-pointer', activeDate === d.fullDate ? 'pink-accent' : 'bg-white']">
                    <span class="text-xs font-black uppercase opacity-60">{{ d.day }}</span>
                    <span class="text-2xl font-black">{{ d.date }}</span>
                </div>
            </div>

            <div class="relative min-h-[400px]">
                <div class="timeline-line"></div>
                <div v-if="activeDate === '2025-12-28'" class="flex gap-6 items-start mb-8 relative z-10 font-black">
                    <div class="w-16 text-center text-xl">06:45</div>
                    <div class="brutal-card flight-fixed flex-1 p-4 rounded-2xl">
                        <div class="flex justify-between items-center"><span class="text-orange-600 italic font-black">IT0236</span><i data-lucide="plane" class="w-4 h-4"></i></div>
                        <p class="text-sm">æ¡ƒåœ’ TPE âœ å‡½é¤¨ HKD (11:10)</p>
                    </div>
                </div>

                <div id="drag-list">
                    <div v-for="(item, index) in filteredSchedule" :key="item.cid" class="mb-6">
                        <div class="flex gap-6 items-center mb-4 ml-16 opacity-70">
                            <div class="flex items-center gap-2 bg-white border-2 border-black px-3 py-1 rounded-full text-[10px] font-black">
                                <i :data-lucide="item.transMode || 'car'" class="w-3 h-3"></i>
                                <span>ç´„ {{ item.transTime || '10' }} åˆ†é˜</span>
                            </div>
                        </div>
                        <div class="flex gap-6 items-start relative z-10">
                            <div class="w-16 text-center text-2xl font-black text-blue-600 italic">{{ item.time || '12:00' }}</div>
                            <div class="brutal-card flex-1 p-5 rounded-3xl bg-white" @click="editItem(item, 'schedules')">
                                <div class="flex justify-between mb-2">
                                    <span class="text-[10px] bg-black text-white px-2 py-0.5 rounded font-black uppercase">{{ item.category }}</span>
                                    <div class="flex gap-2">
                                        <button @click.stop="openMaps(item.title)" class="p-2 bg-blue-100 border-2 border-black rounded-xl"><i data-lucide="navigation" class="w-4 h-4"></i></button>
                                        <div class="drag-handle p-2 border-2 border-black rounded-xl bg-gray-100"><i data-lucide="grip-vertical" class="w-4 h-4"></i></div>
                                    </div>
                                </div>
                                <h3 class="text-xl font-black leading-tight">{{ item.title }}</h3>
                                <div class="text-[10px] font-bold opacity-60 mt-1 space-y-0.5">
                                    <p v-if="item.hours">ğŸ•’ ç‡Ÿæ¥­ï¼š{{ item.hours }}</p>
                                    <p v-if="item.ticket">ğŸ« é–€ç¥¨ï¼š{{ item.ticket }}</p>
                                </div>
                                <img v-if="item.image" :src="item.image" class="photo-box mt-3 shadow-md">
                                <p v-if="item.note" class="text-sm mt-3 border-t-2 border-black pt-2 italic opacity-60">å‚™è¨»ï¼š{{ item.note }}</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div v-if="activeDate === '2026-01-01'" class="flex gap-6 items-start mt-10 relative z-10 font-black">
                    <div class="w-16 text-center text-xl">12:20</div>
                    <div class="brutal-card flight-fixed flex-1 p-4 rounded-2xl">
                        <div class="flex justify-between items-center"><span class="text-orange-600 italic font-black">IT0237</span><i data-lucide="plane" class="w-4 h-4 rotate-180"></i></div>
                        <p class="text-sm">å‡½é¤¨ HKD âœ æ¡ƒåœ’ TPE (16:00)</p>
                    </div>
                </div>
            </div>
        </section>

        <section v-if="currentTab === 'shop'" class="space-y-6">
            <div class="brutal-card p-4 rounded-2xl bg-blue-50 border-4">
                <div class="grid grid-cols-3 gap-2 text-center text-[10px] font-black italic">
                    <div v-for="n in [1,3,5,10,20,30]" class="bg-white border-2 border-black rounded-lg p-1">{{n}}k Â¥ âœ ${{n*210}}</div>
                </div>
            </div>
            <div class="brutal-card p-6 rounded-3xl bg-white border-4">
                <h3 class="font-black mb-4 underline italic">å…ç¨…è¨ˆç®—æ©Ÿ (æ»¿ 5000 å…ç¨…)</h3>
                <div class="flex gap-2 mb-4">
                    <input type="number" v-model.number="taxCalc.input" placeholder="é‡‘é¡" class="flex-1">
                    <select v-model="taxCalc.type" class="w-24 font-black"><option value="C">æ¶ˆè€—å“</option><option value="G">ä¸€èˆ¬å“</option></select>
                    <button @click="addTax" class="bg-black text-white px-4 rounded-xl font-black">åŠ </button>
                </div>
                <div class="text-sm font-black space-y-1">
                    <p>æ¶ˆè€—å“ç´¯è¨ˆ: <span :class="taxCalc.sumC >= 5000 ? 'text-green-600':'text-red-500'">Â¥{{taxCalc.sumC}}</span></p>
                    <p>ä¸€èˆ¬å“ç´¯è¨ˆ: <span :class="taxCalc.sumG >= 5000 ? 'text-green-600':'text-red-500'">Â¥{{taxCalc.sumG}}</span></p>
                    <p class="text-blue-600 text-lg border-t-2 border-black pt-2 mt-2 font-black italic uppercase">é€€ç¨…å¾Œä¼°è¨ˆ: Â¥{{calcTaxResult}} <button @click="resetTax" class="text-xs underline text-gray-400 ml-2 font-normal">é‡ç½®</button></p>
                </div>
            </div>
            <div class="grid grid-cols-2 md:grid-cols-3 gap-6">
                <div v-for="item in shoppingList" :key="item.cid" @click="editItem(item, 'shopping')" class="brutal-card rounded-[30px] overflow-hidden bg-white">
                    <img v-if="item.image" :src="item.image" class="photo-box border-none rounded-none">
                    <div class="p-4 font-black">
                        <p class="text-sm truncate leading-tight">{{ item.title }}</p>
                        <p class="text-xs text-blue-500 mt-1 italic">Â¥{{ item.amount }} | {{ item.payer === 'pink' ? 'ğŸ’—':'ğŸ’™' }}</p>
                    </div>
                </div>
            </div>
        </section>

        <section v-if="currentTab === 'cost'" class="space-y-6">
            <div class="brutal-card p-6 rounded-[40px] bg-white border-4 shadow-[10px_10px_0px_#000]">
                <div class="pink-accent p-4 rounded-2xl border-2 border-black text-center font-black mb-6">
                    <p class="text-sm italic opacity-70 uppercase tracking-tighter">{{ splitReport.message }}</p>
                    <p class="text-4xl italic tracking-tighter">${{ Math.round(splitReport.diff) }}</p>
                </div>
                <div class="grid grid-cols-2 gap-4 font-black text-center">
                    <div class="bg-pink-50 border-2 border-black rounded-2xl p-4">
                        <p class="text-[10px] uppercase opacity-50 mb-1">ğŸ’— å€‹äººç¸½èŠ±è²»(TWD)</p>
                        <p class="text-2xl text-pink-600 italic">${{ Math.round(splitReport.pinkFinal) }}</p>
                    </div>
                    <div class="bg-blue-50 border-2 border-black rounded-2xl p-4">
                        <p class="text-[10px] uppercase opacity-50 mb-1">ğŸ’™ å€‹äººç¸½èŠ±è²»(TWD)</p>
                        <p class="text-2xl text-blue-600 italic">${{ Math.round(splitReport.blueFinal) }}</p>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 gap-8">
                <div v-for="c in costs" :key="c.cid" @click="editItem(c, 'costs')" class="brutal-card rounded-[40px] overflow-hidden bg-white">
                    <img v-if="c.image" :src="c.image" class="w-full aspect-video object-cover border-b-4 border-black">
                    <div v-else class="h-24 bg-gray-100 flex items-center justify-center border-b-4 border-black text-4xl opacity-20">{{ c.payer === 'pink' ? 'ğŸ’—':'ğŸ’™' }}</div>
                    <div class="p-5 font-black">
                        <div class="flex justify-between items-start">
                            <div>
                                <h3 class="text-xl underline decoration-blue-300 italic">{{ c.title }}</h3>
                                <p class="text-[10px] opacity-40 mt-1 uppercase tracking-widest">{{ c.date }} | {{ c.payMethod || 'ç¾é‡‘' }}</p>
                            </div>
                            <span :class="c.payer === 'pink' ? 'bg-pink-200':'bg-blue-200'" class="px-4 py-1 border-2 border-black rounded-full text-xs italic uppercase tracking-tighter">Payer: {{ c.payer === 'pink' ? 'ğŸ’—':'ğŸ’™' }}</span>
                        </div>
                        <div class="mt-4 grid grid-cols-2 gap-2 border-t-2 border-black border-dotted pt-4">
                            <div class="text-left"><p class="text-[10px] opacity-60 uppercase italic">Total Amount</p><p class="text-xl">{{ c.currency === 'JPY' ? 'Â¥':'$' }}{{ c.amount }}</p></div>
                            <div class="text-right"><p class="text-[10px] text-pink-500 uppercase italic">Personal Share (TWD)</p><p class="text-xl text-pink-600 italic">${{ Math.round((c.currency === 'JPY' ? c.amount * 0.21 : c.amount) / (c.isSplit ? 2 : 1)) }}</p></div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <button @click="prepareNew" class="fixed bottom-28 right-8 w-16 h-16 bg-black text-white rounded-full flex items-center justify-center shadow-2xl z-50 brutal-btn active:scale-90 transition-transform"><i data-lucide="plus" class="w-8 h-8"></i></button>

    <transition name="modal">
        <div v-if="showModal" class="fixed inset-0 z-[100] flex items-center justify-center p-6 bg-black/60">
            <div class="brutal-card bg-white w-full max-w-lg rounded-[40px] p-8 max-h-[90vh] overflow-y-auto">
                <div class="space-y-4 font-black">
                    <div class="flex flex-col items-center">
                        <img v-if="form.image" :src="form.image" class="photo-box mb-3 shadow-lg">
                        <button @click="$refs.fileInp.click()" class="brutal-card w-full py-2 bg-yellow-300 text-xs italic">ğŸ“· ä¸Šå‚³ç…§ç‰‡ / å›æ†¶éŒ„</button>
                        <input type="file" ref="fileInp" class="hidden" @change="handleFileUpload" accept="image/*">
                    </div>
                    
                    <div class="flex gap-2">
                        <select v-model="form.category" class="flex-1">
                            <option value="æ™¯é»">ğŸ“ æ™¯é»</option><option value="ä½å®¿">ğŸ¨ ä½å®¿</option><option value="ç¾é£Ÿ">ğŸœ ç¾é£Ÿ</option>
                            <option value="è³¼ç‰©">ğŸ›ï¸ è³¼ç‰©</option><option value="èˆªç­">âœˆï¸ èˆªç­</option><option value="å…¶ä»–">ğŸŒ€ å…¶ä»–</option>
                        </select>
                        <select v-if="currentTab !== 'schedule'" v-model="form.currency" class="w-24"><option value="JPY">Â¥ JPY</option><option value="TWD">$ TWD</option></select>
                    </div>

                    <input v-model="form.title" placeholder="æ¨™é¡Œåç¨± (å¿…å¡«)">

                    <div v-if="currentTab === 'schedule'" class="space-y-4">
                        <input v-model="form.hours" placeholder="ç‡Ÿæ¥­ / å…¥ä½æ™‚é–“ (é¸å¡«)">
                        <input v-if="form.category === 'æ™¯é»'" v-model="form.ticket" placeholder="é–€ç¥¨è³‡è¨Š (é¸å¡«)">
                        <div class="grid grid-cols-2 gap-2">
                            <input v-model="form.time" type="time">
                            <select v-model="form.transMode"><option value="car">ğŸš— é–‹è»Š</option><option value="walking">ğŸš¶ æ­¥è¡Œ</option><option value="bus">ğŸšŒ å…¬è»Š/å¤§çœ¾</option></select>
                        </div>
                        <input v-model.number="form.transTime" type="number" placeholder="äº¤é€šæ‰€éœ€åˆ†é˜">
                    </div>

                    <div v-if="currentTab !== 'schedule'" class="space-y-4">
                        <div class="grid grid-cols-2 gap-3">
                            <input v-model.number="form.amount" type="number" placeholder="è¼¸å…¥é‡‘é¡">
                            <select v-model="form.payMethod"><option value="ç¾é‡‘">ğŸ’µ ç¾é‡‘ä»˜æ¬¾</option><option value="åˆ·å¡">ğŸ’³ åˆ·å¡ä»˜æ¬¾</option></select>
                        </div>
                        <div class="grid grid-cols-2 gap-3 bg-gray-50 p-3 border-2 border-black rounded-xl text-[10px]">
                            <div class="flex gap-2 items-center">æ”¯ä»˜äºº:<label class="flex items-center"><input type="radio" v-model="form.payer" value="pink">ğŸ’—</label><label class="flex items-center"><input type="radio" v-model="form.payer" value="blue">ğŸ’™</label></div>
                            <label class="text-right flex items-center justify-end">å¹³æ”¤? <input type="checkbox" v-model="form.isSplit" class="ml-1 w-4 h-4"></label>
                        </div>
                    </div>

                    <textarea v-model="form.note" placeholder="ç‰¹è‰²ç´°ç¯€ã€å¿ƒå¾—å‚™è¨»..." rows="2"></textarea>
                    
                    <div class="flex gap-3 pt-2">
                        <button v-if="isEditing" @click="delItem" class="brutal-card bg-red-400 p-3 rounded-xl flex-1 font-black">åˆªé™¤</button>
                        <button @click="saveToCloud" class="brutal-card pink-accent p-3 rounded-xl flex-[2] font-black italic">SAVE & SYNC</button>
                    </div>
                </div>
            </div>
        </div>
    </transition>
</div>

<script>
// Firebase è³‡è¨Š
const firebaseConfig = { apiKey: "AIzaSyCAxd41_3A4bnrI0M0n4Br0GK62zkKqIqY", authDomain: "hakodate-trip-app.firebaseapp.com", databaseURL: "https://hakodate-trip-app-default-rtdb.firebaseio.com", projectId: "hakodate-trip-app", storageBucket: "hakodate-trip-app.firebasestorage.app", messagingSenderId: "632761576586", appId: "1:632761576586:web:19d77a52326cb62cd1d173" };
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const { createApp, ref, computed, onMounted, watch, nextTick } = Vue;

createApp({
    setup() {
        const currentTab = ref('schedule'); const activeDate = ref('2025-12-28');
        const showModal = ref(false); const isEditing = ref(false); const currentEditPath = ref('');
        const form = ref({}); const schedules = ref([]); const costs = ref([]); const shoppingList = ref([]);
        const taxCalc = ref({ input: null, type: 'C', sumC: 0, sumG: 0 });

        onMounted(() => {
            db.ref('schedules').on('value', s => { const v = s.val(); schedules.value = v ? Object.keys(v).map(k => ({...v[k], cid: k})) : []; initDraggable(); });
            db.ref('costs').on('value', s => { const v = s.val(); costs.value = v ? Object.keys(v).map(k => ({...v[k], cid: k})) : []; });
            db.ref('shopping').on('value', s => { const v = s.val(); shoppingList.value = v ? Object.keys(v).map(k => ({...v[k], cid: k})) : []; });
            lucide.createIcons();
        });

        const initDraggable = () => {
            nextTick(() => { const el = document.getElementById('drag-list'); if (el) { Sortable.create(el, { handle: '.drag-handle', animation: 150, onEnd: (evt) => {
                const items = [...filteredSchedule.value]; const [movedItem] = items.splice(evt.oldIndex, 1); items.splice(evt.newIndex, 0, movedItem);
                items.forEach((item, index) => { db.ref(`schedules/${item.cid}`).update({ order: index }); });
            }}); } });
        };

        const handleFileUpload = (e) => {
            const file = e.target.files[0]; if (!file) return;
            const reader = new FileReader(); reader.onload = (event) => {
                const img = new Image(); img.src = event.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas'); const MAX = 600; let w = img.width, h = img.height;
                    if(w > h) { if(w > MAX) { h *= MAX/w; w = MAX; } } else { if(h > MAX) { w *= MAX/h; h = MAX; } }
                    canvas.width = w; canvas.height = h; canvas.getContext('2d').drawImage(img, 0, 0, w, h);
                    form.value.image = canvas.toDataURL('image/jpeg', 0.5);
                };
            }; reader.readAsDataURL(file);
        };

        const splitReport = computed(() => {
            let pPaid = 0, bPaid = 0, pOwn = 0, bOwn = 0;
            costs.value.forEach(c => {
                const twd = c.currency === 'JPY' ? c.amount * 0.21 : c.amount;
                if (c.payer === 'pink') pPaid += twd; else bPaid += twd;
                if (c.isSplit) { pOwn += twd/2; bOwn += twd/2; } else { if (c.payer === 'pink') pOwn += twd; else bOwn += twd; }
            });
            const diff = pPaid - pOwn;
            return { diff: Math.abs(diff), message: diff >= 0 ? "BLUE éœ€çµ¦ PINK" : "PINK éœ€çµ¦ BLUE", pinkFinal: pOwn, blueFinal: bOwn };
        });

        const calcTaxResult = computed(() => {
            let r = 0; r += (taxCalc.value.sumC >= 5000) ? taxCalc.value.sumC * 0.909 : taxCalc.value.sumC;
            r += (taxCalc.value.sumG >= 5000) ? taxCalc.value.sumG * 0.909 : taxCalc.value.sumG;
            return Math.round(r);
        });

        const saveToCloud = () => {
            if(!form.value.title) return alert('è«‹å¡«å¯«æ¨™é¡Œ');
            let path = '';
            if(currentTab.value === 'schedule') path = 'schedules';
            else if(currentTab.value === 'shop') path = 'shopping';
            else path = 'costs';

            if(isEditing.value) { 
                db.ref(`${currentEditPath.value}/${form.value.cid}`).update({...form.value, date: activeDate.value}); 
            } else { 
                const newRef = db.ref(path).push({...form.value, date: activeDate.value, id: Date.now(), order: 999}); 
                // è³¼ç‰©èˆ‡åˆ†å¸³é€£å‹•
                if (currentTab.value === 'shop' && form.value.amount > 0) { 
                    db.ref('costs').push({...form.value, date: activeDate.value, id: Date.now(), shopRef: newRef.key}); 
                }
            }
            showModal.value = false;
        };

        const editItem = (item, path) => { isEditing.value = true; currentEditPath.value = path; form.value = { ...item }; showModal.value = true; };
        const delItem = () => { if(confirm('ç¢ºå®šåˆªé™¤ï¼Ÿæ­¤å‹•ä½œä¸å¯å¾©åŸ')) { db.ref(`${currentEditPath.value}/${form.value.cid}`).remove(); if (currentEditPath.value === 'shopping') { costs.value.filter(c => c.shopRef === form.value.cid).forEach(c => db.ref(`costs/${c.cid}`).remove()); } showModal.value = false; } };

        watch([currentTab, showModal, activeDate], () => nextTick(() => { lucide.createIcons(); initDraggable(); }));

        return { currentTab, activeDate, showModal, isEditing, form, schedules, costs, shoppingList, splitReport, taxCalc, calcTaxResult, addTax: () => { if(taxCalc.value.input){ if(taxCalc.value.type==='C') taxCalc.value.sumC+=taxCalc.value.input; else taxCalc.value.sumG+=taxCalc.value.input; taxCalc.value.input=null; } }, resetTax: () => { taxCalc.value.sumC=0; taxCalc.value.sumG=0; }, prepareNew: () => { isEditing.value = false; form.value = { title:'', time:'12:00', amount:null, category:'æ™¯é»', currency:'JPY', payer:'pink', isSplit: true, payMethod:'ç¾é‡‘', image: null, transMode: 'car', transTime: 10 }; showModal.value = true; }, saveToCloud, editItem, delItem, handleFileUpload, openMaps: (n) => window.open(`http://googleusercontent.com/maps.google.com/?q=${encodeURIComponent(n)}`, '_blank'), activeCats:['æ™¯é»','ä½å®¿','ç¾é£Ÿ','è³¼ç‰©','èˆªç­','å…¶ä»–'], tabs: [{id:'schedule',icon:'map'}, {id:'shop',icon:'shopping-basket'}, {id:'cost',icon:'banknote'}], dates: [{day:'Sun',date:'28',fullDate:'2025-12-28'},{day:'Mon',date:'29',fullDate:'2025-12-29'},{day:'Tue',date:'30',fullDate:'2025-12-30'},{day:'Wed',date:'31',fullDate:'2025-12-31'},{day:'Thu',date:'01',fullDate:'2026-01-01'}], filteredSchedule: computed(() => schedules.value.filter(s => s.date === activeDate.value).sort((a,b) => a.order - b.order)) };
    }
}).mount('#app');
</script>
</body>
</html>

